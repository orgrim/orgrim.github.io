<!DOCTYPE html>


<html lang="fr" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Configuration réseau pour virtualiser chez OVH - code. grind. sleep.</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="https://www.orgrim.net/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://www.orgrim.net/favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="https://www.orgrim.net/css/style.6155b6d8eded05b985178f56a637943b3e7fcfccc913d9c656bbebce7c91cc6b.css" integrity="sha256-YVW22O3tBbmFF49WpjeUOz5/z8zJE9nGVrvrznyRzGs=">
    





    





    
        <link rel="stylesheet" href="https://www.orgrim.net/css/custom.css?rnd=1611177961">
    


    





    
        <link rel="stylesheet" href="https://www.orgrim.net/css/syntax.css?rnd=1611177961">
    




<meta property="og:title" content="Configuration réseau pour virtualiser chez OVH" />
<meta property="og:description" content="Sur mon serveur chez OVH, j&rsquo;ai un ensemble de machines virtuelles KVM et (bientôt) de conteneurs LXC. Pour fournir du réseau à tout ce petit monde, j&rsquo;utilise de l&rsquo;IPv4 et de l&rsquo;IPv6, voici comment c&rsquo;est configuré.
Pour l&rsquo;IPv4, on a un nombre limité d&rsquo;IP publiques parce que ça vaut de la thune et que ça va être de plus en tendu de multiplier les adresses, il nous faut un réseau privé (beurk), du NAT (rebeurk) et des redirections à base d&rsquo;iptables (re-rebeurk)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.orgrim.net/post/2011-07-04-configuration-reseau-pour-virtualiser-chez-ovh/" />
<meta property="article:published_time" content="2011-07-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2011-07-04T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Configuration réseau pour virtualiser chez OVH"/>
<meta name="twitter:description" content="Sur mon serveur chez OVH, j&rsquo;ai un ensemble de machines virtuelles KVM et (bientôt) de conteneurs LXC. Pour fournir du réseau à tout ce petit monde, j&rsquo;utilise de l&rsquo;IPv4 et de l&rsquo;IPv6, voici comment c&rsquo;est configuré.
Pour l&rsquo;IPv4, on a un nombre limité d&rsquo;IP publiques parce que ça vaut de la thune et que ça va être de plus en tendu de multiplier les adresses, il nous faut un réseau privé (beurk), du NAT (rebeurk) et des redirections à base d&rsquo;iptables (re-rebeurk)."/>









    
</head>
<body>
    <a class="skip-main" href="#main">Aller au contenu</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/">code. grind. sleep.</a>
</h1>

    <nav>
        
        
        <a class="" href="https://www.orgrim.net/post" title="">Blog</a>
        
        <a class="" href="https://www.orgrim.net/categories" title="">Categories</a>
        
        <a class="" href="https://www.orgrim.net/tags" title="">Tags</a>
        
    </nav>


            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post">
        <header class="post-header">
            <h1 class="post-title">Configuration réseau pour virtualiser chez OVH</h1>
        </header>
        <div class="content">
            <p>Sur mon serveur chez OVH, j&rsquo;ai un ensemble de machines virtuelles KVM et
(bientôt) de conteneurs LXC. Pour fournir du réseau à tout ce petit
monde, j&rsquo;utilise de l&rsquo;IPv4 et de l&rsquo;IPv6, voici comment c&rsquo;est configuré.</p>
<p>Pour l&rsquo;IPv4, on a un nombre limité d&rsquo;IP publiques parce que ça vaut de
la thune et que ça va être de plus en tendu de multiplier les adresses,
il nous faut un réseau privé (beurk), du NAT (rebeurk) et des
redirections à base d&rsquo;iptables (re-rebeurk). Il nous faut surtout un
bridge, c&rsquo;est une Debian donc ça se passe dans
<code>/etc/network/interfaces</code> :</p>
<pre><code>auto lo
iface lo inet loopback

auto eth0
iface eth0 inet manual

auto br0
iface br0 inet static
        bridge_ports eth0
        bridge_fd 0
        bridge_maxwait 0
        address 188.165.205.xxx
        netmask 255.255.255.0
        network 188.165.205.0
        broadcast 188.165.205.255
        gateway 188.165.205.254
        post-up iptables -t nat -A POSTROUTING -s 10.42.0.0/24 -o br0 -j SNAT --to 188.165.205.xxx
        pre-down iptables -t nat -D POSTROUTING -s 10.42.0.0/24 -o br0 -j SNAT --to 188.165.205.xxx

iface br0 inet6 static
        address 2001:41D0:xxxx:96ce::1
        netmask 64

auto br0:0
iface br0:0 inet static
        address 10.42.0.1
        netmask 255.255.255.0
</code></pre>
<p>Pour le bridge, on met l&rsquo;IPv4 publique et une règle iptable pour NAT-er
ce qui sort. Le réseau privé est 10.42.0.0/24, on peut bien sûr choisir
ce qu&rsquo;on veut dans ce que fourni la RFC 1918.</p>
<p>Pour l&rsquo;IPv6, chez OVH c&rsquo;est bizarre : il fournissent un prefix 64 bit et
avec une route accessible sur le /56 incluant, mais pas à partir du /64.
Il faut donc ruser de la façon suivante niveau routage.</p>
<p>On assigne l&rsquo;IPv6 avec le prefix /64, c&rsquo;est plus propre, sinon le kernel se plaint avec /56 :</p>
<pre><code># ip -6 addr add 2001:41D0:xxxx:96ce::1/64 dev br0
</code></pre>
<p>On met une route pour atteindre la gateway dans le /56 :</p>
<pre><code># ip -6 route add 2001:41d0:xxxx:96ce::/56 dev br0
</code></pre>
<p>On met la route par défaut :</p>
<pre><code># ip -6 route add default via 2001:41d0:xxxx:96ff:ff:ff:ff:ff
</code></pre>
<p>Pour avoir cette configuration appliquée automatiquement, il faut créer
<code>/etc/network/if-up.d/ovh-ipv6-route</code> :</p>
<pre><code>#!/bin/sh

if [ &quot;$IFACE&quot; = &quot;br0&quot; ]; then
    ip -6 route add 2001:41d0:2:96ce::/56 dev br0
    ip -6 route add default via 2001:41d0:2:96ff:ff:ff:ff:ff
fi
</code></pre>
<p>Et pour l&rsquo;arrêt, <code>/etc/network/if-down.d/ovh-ipv6-route</code> :</p>
<pre><code>#!/bin/sh

if [ &quot;$IFACE&quot; = &quot;br0&quot; ]; then
    ip -6 route del default via 2001:41d0:2:96ff:ff:ff:ff:ff
    ip -6 route del 2001:41d0:2:96ce::/56 dev br0
fi
</code></pre>
<p>Il faut ensuite activer le forward entre interfaces, sinon pas de
routage vers les VM, dans <code>/etc/sysctl.conf</code> :</p>
<pre><code>net.ipv6.conf.all.forwarding=1
</code></pre>
<p>Enfin, le routage chez OVH ne permet pas d&rsquo;intercaler un routeur pour
découper le /64, il faut donc ruser avec du proxy NDP (Neighbor
Discovery Protocol).</p>
<p>On active le proxy NDP, dans <code>/etc/sysctl.conf</code> :</p>
<pre><code>net.ipv6.conf.all.proxy_ndp=1
</code></pre>
<p>On ajoute les IP à proxiser, celle de la gateway et chacune des IP
fournies aux VM :</p>
<pre><code># ip neigh add proxy 2001:41d0:xxxx:96ff:ff:ff:ff:ff dev br0
# ip neigh add proxy 2001:41d0:xxxx:96ce::2 dev br0
</code></pre>
<p>En cas de reboot d&rsquo;une VM, il faut d&rsquo;abord virer ses IP du proxy, puis
les remettre, sinon le kernel de la VM se plein d&rsquo;une duplication
d&rsquo;adresse :</p>
<pre><code># ip neigh del proxy 2001:41d0:xxxx:96ce::2 dev br0
-&gt; reboot de la VM
# ip neigh add proxy 2001:41d0:xxxx:96ce::2 dev br0
</code></pre>

        </div>
        

    


<div class="post-info">
    
        <div class="post-date">2011-07-04</div>
    
    <div class="post-taxonomies">
        
            <ul class="post-categories">
                
                    <li><a href="https://www.orgrim.net/categories/">Unix</a></li>
                
            </ul>
            
            
                <ul class="post-tags">
                    
                        <li><a href="https://www.orgrim.net/tags/unix">#unix</a></li>
                    
                        <li><a href="https://www.orgrim.net/tags/debian">#debian</a></li>
                    
                        <li><a href="https://www.orgrim.net/tags/lxc">#lxc</a></li>
                    
                        <li><a href="https://www.orgrim.net/tags/ipv6">#ipv6</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    

    


        </main>
        
            <footer class="common-footer">
    
    
        <ul class="language-select">

<li><a href="https://www.orgrim.net/">Français</a></li>

<li><a href="https://www.orgrim.net/en/">English</a></li>

</ul>
    

    <div class="common-footer-bottom">
        
            
            <ul class="footer-menu">
            
            <li><a class="" href="https://twitter.com/orgrim" title="Twitter">@orgrim</a></li>
            
            <li><a class="" href="https://github.com/orgrim" title="">github</a></li>
            
            </ul>
        
        <div class="copyright">
            <p>© Nicolas Thauvin, 2021<br>
            Propulsé par <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, thème <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.
            </p>  
        </div> 

        

    



    <button class="theme-switcher">
        Thème sombre
    </button>

    <script>
    const STORAGE_KEY = 'user-color-scheme'
    const defaultTheme = "dark"

    let currentTheme
    let switchButton
    let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

    const autoChangeScheme = e => {
        currentTheme = e.matches ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', currentTheme)
        changeButtonText()
    }

    document.addEventListener('DOMContentLoaded', function() {
        switchButton = document.querySelector('.theme-switcher')
        currentTheme = detectCurrentScheme()
        if (currentTheme == 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
        }
        if (currentTheme == 'auto') {
            autoChangeScheme(autoDefinedScheme);
            autoDefinedScheme.addListener(autoChangeScheme);
        }
        changeButtonText()
        switchButton.addEventListener('click', switchTheme, false)
    })

    function detectCurrentScheme() {
        if (localStorage.getItem(STORAGE_KEY)) {
            return localStorage.getItem(STORAGE_KEY)
        } 
        if (defaultTheme) {
            return defaultTheme
        } 
        if (!window.matchMedia) {
            return 'light'
        } 
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark'
        }
        return 'light'
    }

    function changeButtonText()
    {   
        switchButton.textContent = currentTheme == 'dark' ?  "Thème clair" : "Thème sombre"
    }

    function switchTheme(e) {
        if (currentTheme == 'dark') {
            localStorage.setItem(STORAGE_KEY, 'light')
            document.documentElement.setAttribute('data-theme', 'light')
            currentTheme = 'light'
        } else {
            localStorage.setItem(STORAGE_KEY, 'dark')
            document.documentElement.setAttribute('data-theme', 'dark')
            currentTheme = 'dark'
        }
        changeButtonText()
    }
    </script>
   
    </div>
</footer>

        
    </div>
</body>
</html>
