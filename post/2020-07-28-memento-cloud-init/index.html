<!DOCTYPE html>


<html lang="fr" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Memento Cloud Init - code. grind. sleep.</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="https://www.orgrim.net/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://www.orgrim.net/favicon.png">

<link rel="stylesheet" href="https://www.orgrim.net/css/light.css?rnd=1609836903" />
<style>

    [data-theme="dark"] {   
        --font-color: #eee;
--bg-color: #212121;

--link-color:#599ada;
--link-state-color:#ff5858;
--link-state-border-color: rgba(238, 54, 54, 0.5);

--thead-bg-color: #343a40;
--table-border-color: lightgrey;

--pre-color: #333;
--pre-bg-color: #f1f1f1;

--bq-color: #ccc;
--hr-color: #333;

--pagination-bg-color: #373737;
--pagination-link-color: #b6b6b6;

--post-info-color: grey;

--switcher-color: #333;
--switcher-bg-color: #fff;

    }

</style>

<link rel="stylesheet" href="https://www.orgrim.net/css/style.css?rnd=1609836903" />

<link rel="stylesheet" href="https://www.orgrim.net/css/custom.css?rnd=1609836903"><link rel="stylesheet" href="https://www.orgrim.net/css/syntax.css?rnd=1609836903">



<meta property="og:title" content="Memento Cloud Init" />
<meta property="og:description" content="Utiliser simplemant Cloud Init avec libvirt" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.orgrim.net/post/2020-07-28-memento-cloud-init/" />
<meta property="article:published_time" content="2020-07-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Memento Cloud Init"/>
<meta name="twitter:description" content="Utiliser simplemant Cloud Init avec libvirt"/>








    
</head>
<body>
    <a class="skip-main" href="#main">Passer au contenu principal</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/">code. grind. sleep.</a>
</h1>

    <nav>
        
        
        <a class="" href="https://www.orgrim.net/post" title="">Blog</a>
        
        <a class="" href="https://www.orgrim.net/categories" title="">Categories</a>
        
        <a class="" href="https://www.orgrim.net/tags" title="">Tags</a>
        
    </nav>


            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post">
        <header class="post-header">
            <h1 class="post-title">Memento Cloud Init</h1>
        </header>
        <div class="content">
            <p>Cloud Init permet de configurer des machines virtuelles au boot, en utilissant des méta données provenant de la plateforme ou tourne la VM (AWS, Azure, GCP, KVM Local, etc). Pour une installation sur KVM avec libvirt, il faut utiliser le module NoCloud :</p>
<ol>
<li>Installer le système dans un KVM, avec <code>virt-manager</code> et une image ISO</li>
<li>Installer le paquet <code>cloud-init</code> (et le paquet <code>sudo</code> pour que le reste fonctionne)</li>
</ol>
<pre><code class="language-console" data-lang="console"># yum install cloud-init sudo
</code></pre><ol start="3">
<li>Eteindre la VM</li>
<li>Créer un répertoire de travail et s&rsquo;y déplacer</li>
<li>Créer les 3 fichiers :</li>
</ol>
<ul>
<li><code>user-data</code> : contient la configuration pour ajouter son user, sa clé SSH, configurer sudo, configurer le mot de passe <code>root</code></li>
<li><code>meta-data</code> : contient la configuration de la machine, le hostname, etc</li>
<li><code>network-config</code> : contient la configuration du réseau</li>
</ul>
<ol start="6">
<li>Créer l&rsquo;image ISO :</li>
</ol>
<pre><code class="language-console" data-lang="console">$ genisoimage -output cloudinit_la_vm.iso -volid cidata -joliet -rock user-data meta-data network-config
</code></pre><ol start="7">
<li>Attacher l&rsquo;image ISO</li>
<li>Démarrer la VM</li>
</ol>
<p>Voici les fichiers à placer dans l&rsquo;image ISO pour avoir le minimum pour finir la configuration de la VM avec Ansible ou autre par la suite :</p>
<p>Fichier <code>user-data</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">#cloud-config</span><span class="w">
</span><span class="w"></span><span class="c"># vim: syntax=yaml</span><span class="w">
</span><span class="w"></span><span class="c">#</span><span class="w">
</span><span class="w"></span><span class="c"># https://cloudinit.readthedocs.io/en/latest/topics/examples.html</span><span class="w">
</span><span class="w"></span><span class="c">#</span><span class="w">
</span><span class="w"></span><span class="nt">chpasswd</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">list</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">     </span><span class="w">     </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Un mot de passe complexe&#34;</span><span class="w"> </span><span class="c"># Change me</span><span class="w">
</span><span class="w">  </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="kc">False</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">orgrim</span><span class="w"> </span><span class="c"># Change me</span><span class="w">
</span><span class="w">    </span><span class="nt">ssh_authorized_keys</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">ssh-rsa AA...= orgrim@hw</span><span class="w">
</span><span class="w">    </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;ALL=(ALL) NOPASSWD:ALL&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/bash</span><span class="w">
</span><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">users</span><span class="w">
</span></code></pre></div><p>Fichier <code>meta-data</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">local-hostname</span><span class="p">:</span><span class="w"> </span><span class="l">centos77.vz.lo</span><span class="w">
</span></code></pre></div><p>Fichier <code>network-config</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w"></span><span class="nt">ethernets</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">eth0</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">eth0</span><span class="w">
</span><span class="w">    </span><span class="nt">addresses</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">10.100.0.59</span><span class="l">/24</span><span class="w">
</span><span class="w">    </span><span class="nt">gateway4</span><span class="p">:</span><span class="w"> </span><span class="m">10.100.0.1</span><span class="w">
</span><span class="w">    </span><span class="nt">nameservers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">search</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">vz.lo]</span><span class="w">
</span><span class="w">      </span><span class="nt">addresses</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">10.100.0.1</span><span class="p">]</span><span class="w">
</span></code></pre></div><p>La machine est configurée avec le hostname <code>centos77.vz.lo</code>, son IP, la gateway, le DNS qui vont bien et un user avec accès root et sa clé SSH pour pouvoir utiliser Ansible pour la suite de la configuration.</p>
<p>La configuration placée dans l&rsquo;image ISO est appliquée à chaque boot.</p>
<p>La documentation : <a href="https://cloudinit.readthedocs.io/en/latest/topics/datasources/nocloud.html">https://cloudinit.readthedocs.io/en/latest/topics/datasources/nocloud.html</a></p>
        </div>
        

    


<div class="post-info">
    
        <div class="post-date">2020-07-28</div>
    
    <div class="post-taxonomies">
        
            <ul class="post-categories">
                
                    <li><a href="https://www.orgrim.net/categories/">Unix</a></li>
                
            </ul>
            
            
                <ul class="post-tags">
                    
                        <li><a href="https://www.orgrim.net/tags/unix">#unix</a></li>
                    
                        <li><a href="https://www.orgrim.net/tags/cloud-init">#cloud-init</a></li>
                    
                        <li><a href="https://www.orgrim.net/tags/libvirt">#libvirt</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    

    


        </main>
        
            <footer class="common-footer">
    
    
        <ul class="language-select">

<li><a href="https://www.orgrim.net/en/">English</a></li>

<li><a href="https://www.orgrim.net/">Français</a></li>

</ul>
    

    <div class="common-footer-bottom">
        
            
            <ul class="footer-menu">
            
            <li><a class="" href="https://twitter.com/orgrim" title="Twitter">@orgrim</a></li>
            
            <li><a class="" href="https://github.com/orgrim" title="">github</a></li>
            
            </ul>
        
        <div class="copyright">
            <p>© Nicolas Thauvin, 2021<br>
            Propulsé par <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, thème <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.
            </p>  
        </div> 

        

    



    <button class="theme-switcher">
        Thème sombre
    </button>

    <script>
    const STORAGE_KEY = 'user-color-scheme'
    const defaultTheme = "dark"

    let currentTheme
    let switchButton
    let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

    const autoChangeScheme = e => {
        currentTheme = e.matches ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', currentTheme)
        changeButtonText()
    }

    document.addEventListener('DOMContentLoaded', function() {
        switchButton = document.querySelector('.theme-switcher')
        currentTheme = detectCurrentScheme()
        if (currentTheme == 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
        }
        if (currentTheme == 'auto') {
            autoChangeScheme(autoDefinedScheme);
            autoDefinedScheme.addListener(autoChangeScheme);
        }
        changeButtonText()
        switchButton.addEventListener('click', switchTheme, false)
    })

    function detectCurrentScheme() {
        if (localStorage.getItem(STORAGE_KEY)) {
            return localStorage.getItem(STORAGE_KEY)
        } 
        if (defaultTheme) {
            return defaultTheme
        } 
        if (!window.matchMedia) {
            return 'light'
        } 
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark'
        }
        return 'light'
    }

    function changeButtonText()
    {   
        switchButton.textContent = currentTheme == 'dark' ?  "Thème léger" : "Thème sombre"
    }

    function switchTheme(e) {
        if (currentTheme == 'dark') {
            localStorage.setItem(STORAGE_KEY, 'light')
            document.documentElement.setAttribute('data-theme', 'light')
            currentTheme = 'light'
        } else {
            localStorage.setItem(STORAGE_KEY, 'dark')
            document.documentElement.setAttribute('data-theme', 'dark')
            currentTheme = 'dark'
        }
        changeButtonText()
    }
    </script>
   
    </div>
</footer>

        
    </div>
</body>
</html>
